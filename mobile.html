<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jeju Mobile Weather</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body {
            margin: 0; padding: 10px; background-color: #222;
            display: flex; flex-direction: column; align-items: center;
            font-family: 'Noto Sans SC', sans-serif; min-height: 100vh; color: #333;
        }
        .dashboard-container {
            display: flex; flex-direction: column; width: 100%; max-width: 600px; gap: 15px; padding-bottom: 30px;
        }
        .capture-card {
            width: 100%; background: #fff; border-radius: 12px; overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); display: flex; flex-direction: column;
            margin-bottom: 5px;
        }

        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .card-header-top {
            background: #eee; padding: 10px; font-weight: 800; font-size: 14px;
            text-align: center; color: #555; border-bottom: 1px solid #ddd;
        }

        /* CCTV */
        #card-cctv { background: #000; border: 1px solid #333; }
        .cctv-header { padding: 10px; background: linear-gradient(90deg, #d32f2f, #f57c00); color: white; text-align: center; font-size: 16px; font-weight: 900; }
        .cctv-content { display: flex; flex-direction: column; gap: 1px; background: #111; }
        .video-container { width: 100%; aspect-ratio: 16/9; position: relative; background: #000; }
        .tag { position: absolute; top: 10px; left: 10px; background: red; color: white; padding: 2px 6px; font-weight: bold; border-radius: 3px; font-size: 10px; z-index: 20; animation: blink 2s infinite; }
        .label { position: absolute; bottom: 8px; left: 10px; text-shadow: 1px 1px 3px rgba(0,0,0,1); color: #fff; font-size: 14px; font-weight: 800; z-index: 10; }
        video { width: 100%; height: 100%; object-fit: cover; }
        @keyframes blink { 0% {opacity: 1;} 50% {opacity: 0.7;} 100% {opacity: 1;} }

        /* ë‚ ì”¨ ê·¸ë¦¬ë“œ (2ì¤„ ë³´ê¸° í•µì‹¬) */
        .loc-section { padding: 15px 10px; border-bottom: 1px solid #eee; }
        .loc-section:last-child { border-bottom: none; }

        .loc-title { font-size: 16px; font-weight: 900; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .badge { font-size: 10px; background: #e3f2fd; color: #1565c0; padding: 2px 6px; border-radius: 4px; font-weight: bold; }

        .w-grid {
            display: flex; flex-wrap: wrap; /* ìë™ ì¤„ë°”ê¿ˆ */
            justify-content: flex-start; gap: 0;
        }
        .w-col {
            width: 14.2%; /* í•œ ì¤„ì— 7ê°œ (100/7) */
            display: flex; flex-direction: column; align-items: center;
            margin-bottom: 10px; /* ì¤„ ê°„ê²© */
        }
        /* ì£¼ê°„ì˜ˆë³´ëŠ” í•œ ì¤„ì— 4ê°œì”© (25%) */
        .weekly-grid .w-col { width: 25%; margin-bottom: 15px; }

        .f-time { font-size: 10px; color: #888; font-weight: 700; margin-bottom: 2px; }
        .f-icon { font-size: 18px; margin-bottom: 0px; }
        .f-temp { font-size: 12px; font-weight: 800; color: #000; }
        .f-rain { font-size: 9px; color: #1976d2; font-weight: 600; }
        .t-high { color: #d32f2f; } .t-low { color: #1976d2; }

        /* CORS ë²„íŠ¼ */
        .cors-btn { display: block; width: 96%; margin: 0 auto; padding: 10px; background: #ff4d4f; color: white; text-align: center; border-radius: 8px; text-decoration: none; font-size: 13px; font-weight: bold; }
    </style>
</head>
<body>
    <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank" class="cors-btn">âš ï¸ ì—¬ê¸° ëˆŒëŸ¬ì„œ [Request Access] í™œì„±í™”í•˜ê¸°</a>

    <div class="dashboard-container">

        <div id="card-cctv" class="capture-card">
            <div class="cctv-header">ğŸ”´ JEJU LIVE CCTV</div>
            <div class="cctv-content">
                <div class="video-container"><div class="tag">LIVE</div><div class="label">ğŸï¸ UDO (ìš°ë„)</div><video id="v1" autoplay muted playsinline></video></div>
                <div class="video-container"><div class="tag">LIVE</div><div class="label">ğŸ”ï¸ HALLA (í•œë¼ì‚°)</div><video id="v2" autoplay muted playsinline></video></div>
            </div>
        </div>

        <div class="capture-card">
            <div class="card-header-top">â˜€ï¸ ì˜¤ëŠ˜ (ì£¼ìš” ë„ì‹¬)</div>
            <div id="daily-group-1">Loading...</div>
        </div>

        <div class="capture-card">
            <div class="card-header-top">ğŸ”ï¸ ì˜¤ëŠ˜ (ê´€ê´‘ì§€)</div>
            <div id="daily-group-2">Loading...</div>
        </div>

        <div class="capture-card">
            <div class="card-header-top">ğŸ“… ì£¼ê°„ ì˜ˆë³´ (3ì¼~10ì¼í›„)</div>
            <div id="weekly-list" style="padding:10px;">Loading...</div>
        </div>
    </div>

<script>
    const API_KEY = '05988a053767a7a6cc5553d077ce7ea541c60806a0160d5ac2e9119ebe5a61ce';
    const PROXY = 'https://cors-anywhere.herokuapp.com/';
    const now = new Date();
    const todayStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;

    function initCCTV() {
        const streams = [
            { id: 'v1', url: 'http://211.114.96.121:1935/jejusi7/11-24.stream/chunklist_w1514884533.m3u8' },
            { id: 'v2', url: 'http://119.65.216.155:1935/live/cctv03.stream_360p/chunklist_w324217178.m3u8' }
        ];
        if (Hls.isSupported()) {
            streams.forEach(s => {
                const v = document.getElementById(s.id);
                const h = new Hls(); h.loadSource(s.url); h.attachMedia(v);
                h.on(Hls.Events.ERROR, function(e,d){ if(d.fatal) h.startLoad(); });
            });
        }
    }

    async function initDailyWeather() {
        // ê·¸ë£¹ 1: ì œì£¼ì‹œ, ì„œê·€í¬
        const locs1 = [{n:"ì œì£¼ì‹œ",x:52,y:38}, {n:"ì„œê·€í¬",x:52,y:32}];
        // ê·¸ë£¹ 2: í•œë¼ì‚°, ìš°ë„
        const locs2 = [{n:"í•œë¼ì‚°",x:52,y:35}, {n:"ìš°ë„",x:60,y:38}];

        const baseTime = now.getHours() < 2 ? "2300" : "0200";
        const baseDate = now.getHours() < 2 ? String(Number(todayStr)-1) : todayStr;

        async function fetchAndRender(locs, divId) {
            const container = document.getElementById(divId);
            container.innerHTML = '';

            for (const loc of locs) {
                let html = '';
                try {
                    const url = `${PROXY}https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst?serviceKey=${API_KEY}&numOfRows=300&pageNo=1&dataType=JSON&base_date=${baseDate}&base_time=${baseTime}&nx=${loc.x}&ny=${loc.y}`;
                    const res = await fetch(url);
                    const json = await res.json();

                    json.response.body.items.item.forEach(i => {
                        if (i.category === 'TMP' && i.fcstDate === todayStr) {
                            const h = parseInt(i.fcstTime.substring(0,2));
                            if (h >= 9 && h <= 22) { // 9ì‹œ~22ì‹œ (14ê°œ ë°ì´í„° -> 7ê°œì”© 2ì¤„)
                                let icon = 'â˜€ï¸';
                                html += `<div class="w-col"><div class="f-time">${h}ì‹œ</div><div class="f-icon">${icon}</div><div class="f-temp">${i.fcstValue}Â°</div></div>`;
                            }
                        }
                    });
                } catch(e) { html = '<div style="width:100%; text-align:center; color:red;">Connection Error</div>'; }

                container.innerHTML += `
                    <div class="loc-section">
                        <div class="loc-title">${loc.n} <span class="badge">09~22ì‹œ</span></div>
                        <div class="w-grid">${html}</div>
                    </div>`;
            }
        }

        await fetchAndRender(locs1, 'daily-group-1');
        await fetchAndRender(locs2, 'daily-group-2');
    }

    async function initWeeklyWeather() {
        const container = document.getElementById('weekly-list');
        const locs = [{ name: "ì œì£¼ì‹œ", regIdTemp: '11G00201', regIdLand: '11G00000' }];

        // ë‚ ì§œ ê³„ì‚° ë¡œì§ (ì˜¤ì „/ì˜¤í›„/NextDay)
        const h = now.getHours();
        let midTmFc, dayShift = 0;
        if (h < 6) {
            const yD = new Date(now); yD.setDate(now.getDate() - 1);
            midTmFc = `${yD.getFullYear()}${String(yD.getMonth()+1).padStart(2,'0')}${String(yD.getDate()).padStart(2,'0')}1800`;
            dayShift = 1;
        } else if (h >= 18) { midTmFc = `${todayStr}1800`; }
        else { midTmFc = `${todayStr}0600`; }

        container.innerHTML = '';

        for (const loc of locs) {
            try {
                const urlT = `${PROXY}https://apis.data.go.kr/1360000/MidFcstInfoService/getMidTa?serviceKey=${API_KEY}&numOfRows=1&pageNo=1&dataType=JSON&regId=${loc.regIdTemp}&tmFc=${midTmFc}`;
                const resT = await fetch(urlT); const jsonT = await resT.json();
                const urlL = `${PROXY}https://apis.data.go.kr/1360000/MidFcstInfoService/getMidLandFcst?serviceKey=${API_KEY}&numOfRows=1&pageNo=1&dataType=JSON&regId=${loc.regIdLand}&tmFc=${midTmFc}`;
                const resL = await fetch(urlL); const jsonL = await resL.json();

                if(jsonT.response.header.resultCode === '00') {
                    const t = jsonT.response.body.items.item[0];
                    const l = jsonL.response.body.items.item[0];
                    let html = '';

                    for(let i=3; i<=10; i++) {
                        const k = i + dayShift; if(k>10) continue;
                        const d = new Date(now); d.setDate(now.getDate() + i);
                        const label = `${d.getMonth()+1}/${d.getDate()}`;

                        let wf = (k<=7) ? (l[`wf${k}Pm`]||l[`wf${k}`]) : l[`wf${k}`];
                        let icon = 'â˜€ï¸';
                        if(wf && wf.includes('ë¹„')) icon='ğŸŒ§ï¸'; else if(wf && wf.includes('êµ¬ë¦„')) icon='â˜ï¸';

                        const min = t[`taMin${k}`]||t[`taMin${k}Low`];
                        const max = t[`taMax${k}`]||t[`taMax${k}High`];

                        html += `<div class="w-col"><div class="f-time">${label}</div><div class="f-icon">${icon}</div><div class="f-temp"><span class="t-high">${max}</span>/<span class="t-low">${min}</span></div></div>`;
                    }
                    container.innerHTML += `<div class="loc-section"><div class="loc-title">ì œì£¼ ì „ì—­ <span class="badge">3ì¼~10ì¼í›„</span></div><div class="w-grid weekly-grid">${html}</div></div>`;
                }
            } catch(e) {}
        }
    }

    initCCTV();
    initDailyWeather();
    setTimeout(initWeeklyWeather, 1000);
</script>
</body>
</html>
