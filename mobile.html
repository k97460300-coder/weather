<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Jeju Weather Dashboard (Final)</title>
    <!-- ëª¨ë°”ì¼ ì•± ì„¤ì • -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#222222">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        /* =========================================
           [CSS ìŠ¤íƒ€ì¼ ì‹œíŠ¸] 
           í™”ë©´ì˜ ë””ìì¸, ë ˆì´ì•„ì›ƒ, ìƒ‰ìƒì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.
           ========================================= */

        /* body: ì „ì²´ í˜ì´ì§€ì˜ ê¸°ë³¸ ë°°ê²½ìƒ‰ê³¼ ì •ë ¬ ì„¤ì • */
        body { 
            margin: 0; padding: 50px; 
            background-color: #222; /* ì–´ë‘ìš´ ë°°ê²½ */
            display: flex; flex-direction: column; align-items: center; /* ë‚´ìš©ë¬¼ ì¤‘ì•™ ì •ë ¬ */
            font-family: 'Noto Sans SC', sans-serif; 
            min-height: 100vh; 
        }

        .dashboard-container { 
            display: flex; flex-wrap: wrap; justify-content: center; 
            gap: 20px; 
            margin-bottom: 50px; 
            width: 100%;
        }

        .capture-card { 
            width: 100%; max-width: 720px; 
            height: auto; min-height: 800px; /* ë†’ì´ ìœ ë™ì ìœ¼ë¡œ ë³€ê²½ */
            background: #fff; border-radius: 24px; overflow: hidden; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
            display: flex; flex-direction: column; flex-shrink: 0; 
        }
        
        /* CORS ì•Œë¦¼ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ë¹¨ê°„ìƒ‰ ë°•ìŠ¤) */
        .cors-alert { 
            width: 100%; max-width: 720px; background: #ff4d4f; color: white; 
            padding: 15px; margin-bottom: 20px; text-align: center; border-radius: 10px; 
            font-weight: bold; cursor: pointer; text-decoration: none; display: block; 
            box-shadow: 0 5px 15px rgba(255, 77, 79, 0.4); animation: pulse 2s infinite; 
        }
        /* ë²„íŠ¼ì´ ì¿µì¿µ ë›°ëŠ” ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.02);} 100% {transform: scale(1);} }

        /* --- CCTV ì¹´ë“œ ì „ìš© ìŠ¤íƒ€ì¼ --- */
        #card-cctv { background: #000; border: 1px solid #333; }
        .cctv-header { padding: 24px; background: linear-gradient(90deg, #ff8c00, #ff0080); color: white; text-align: center; font-size: 32px; font-weight: 900; letter-spacing: 2px; flex-shrink: 0; }
        .cctv-content { display: flex; flex-direction: column; flex: 1; background: #111; overflow: hidden; }
        .video-container { flex: 1; position: relative; overflow: hidden; width: 100%; background: #000; border-bottom: 1px solid #333; display: flex; justify-content: center; align-items: center; }
        .tag { position: absolute; top: 20px; left: 20px; background: rgba(220,0,0,0.9); color: white; padding: 6px 14px; font-weight: bold; border-radius: 6px; font-size: 16px; z-index: 20; animation: blink 2s infinite; }
        .label { position: absolute; bottom: 20px; left: 20px; text-shadow: 2px 2px 6px rgba(0,0,0,0.9); color: #fff; font-size: 28px; font-weight: 800; z-index: 10; }
        video { width: 100%; height: 100%; object-fit: contain; }
        @keyframes blink { 0% {opacity: 1;} 50% {opacity: 0.7;} 100% {opacity: 1;} }

        /* --- ë‚ ì”¨ ì¹´ë“œ ê³µí†µ ìŠ¤íƒ€ì¼ --- */
        .weather-container { padding: 40px; display: flex; flex-direction: column; height: 100%; box-sizing: border-box; }
        .w-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; font-size: 16px; color: #888; font-weight: 600; flex-shrink: 0; }
        .w-title { font-size: 32px; font-weight: 900; color: #000; }
        .w-content { display: flex; flex-direction: column; gap: 16px; flex: 1; overflow: visible; }
        
        .loc-card { border: 2px solid #f1f3f5; border-radius: 16px; padding: 16px 10px; display: flex; flex-direction: column; background: #fff; }
        .loc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 0 8px; }
        .loc-name { font-size: 22px; font-weight: 800; color: #000; }
        .loc-sub { font-size: 14px; color: #888; margin-left: 6px; }
        .loc-badge { font-size: 14px; font-weight: 700; padding: 4px 10px; border-radius: 6px; background: #fff2f1; color: #d93025; border: 1px solid #ffa39e; }
        
        /* Grid (ë‚ ì”¨ ì•„ì´ì½˜ë“¤ì´ ë‚˜ì—´ë˜ëŠ” ì¤„) */
        .w-grid { display: flex; padding-top: 10px; border-top: 2px solid #f1f3f5; justify-content: space-between; flex-wrap: nowrap; gap: 0px; }
        
        .w-col { display: flex; flex-direction: column; align-items: center; text-align: center; }

        /* [ì˜¤ëŠ˜ ë‚ ì”¨] ì „ìš©: 14ê°œ ë°ì´í„°ë¥¼ í•œ ì¤„ì— ê½‰ ì±„ìš°ê¸° (ìŠ¤í¬ë¡¤ X) */
        #list-daily .w-grid { overflow-x: hidden; } 
        #list-daily .w-col { flex: 1; min-width: 0; } /* flex: 1ì€ ê³µê°„ì„ ê· ë“±í•˜ê²Œ ë‚˜ëˆˆë‹¤ëŠ” ëœ» */
        
        /* [ì£¼ê°„ ë‚ ì”¨] ì „ìš©: 11ê°œ ë°ì´í„°ë¥¼ í•œ ì¤„ì— ê½‰ ì±„ìš°ê¸° (ìŠ¤í¬ë¡¤ X) */
        #list-weekly .w-grid { overflow-x: hidden; } 
        #list-weekly .w-col { flex: 1; min-width: 0; }

        /* í…ìŠ¤íŠ¸ í°íŠ¸ ì„¤ì • */
        .f-time { font-size: 11px; color: #666; margin-bottom: 4px; font-weight: 700; letter-spacing: -0.5px; line-height: 1.3; white-space: nowrap; }
        .f-icon { font-size: 20px; margin-bottom: 2px; } 
        .f-temp { font-size: 12px; font-weight: 800; color: #000; margin-bottom: 1px; white-space: nowrap; }
        .f-wind { font-size: 9px; color: #1a73e8; font-weight: 600; white-space: nowrap; margin-bottom: 1px; }
        .f-rain { font-size: 9px; color: #888; font-weight: 500; white-space: nowrap; }
        .unit { font-size: 0.7em; font-weight: 400; color: #999; margin-left: 1px; }

        /* ì˜¨ë„ ë° ê°•ìˆ˜í™•ë¥  ìƒ‰ìƒ */
        .t-high { color: #ff4d4f; } /* ìµœê³ ê¸°ì˜¨ ë¹¨ê°• */
        .t-low { color: #1a73e8; }  /* ìµœì €ê¸°ì˜¨ íŒŒë‘ */
        .pop-blue { color: #339af0; font-weight: 700; } /* ê°•ìˆ˜í™•ë¥  íŒŒë‘ */

        #card-weekly .weather-container { padding: 35px 30px; }
        #card-weekly .w-content { gap: 14px; }

        /* í•˜ë‹¨ í‘¸í„° ë° ë§í¬ ë²„íŠ¼ */
        footer { text-align: center; font-size: 14px; color: #ccc; border-top: 1px solid #f8f9fa; padding-top: 20px; margin-top: auto; font-weight: 500;}
        .link-footer { width: 100%; max-width: 1000px; background: #222; padding: 30px; border-top: 2px solid #333; display: flex; justify-content: center; align-items: center; gap: 30px; margin-top: auto; }
        .btn { color: #eee; text-decoration: none; font-size: 16px; font-weight: bold; padding: 14px 24px; background: #333; border-radius: 12px; border: 1px solid #555; display: flex; align-items: center; gap: 10px; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .btn:hover { background: #1a73e8; border-color: #1a73e8; color: white; transform: translateY(-3px); }
    </style>
</head>
<body>
    <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank" class="cors-alert">
        âš ï¸ 1. ì—¬ê¸°ë¥¼ í´ë¦­í•´ì„œ [Request temporary access] ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.<br>
        âš ï¸ 2. ê·¸ëŸ° ë‹¤ìŒ ì´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ë‚ ì”¨ê°€ ë‚˜ì˜µë‹ˆë‹¤.
    </a>

    <div class="dashboard-container">
        <div id="card-cctv" class="capture-card">
            <div class="cctv-header">JEJU LIVE NOW ğŸ”´</div>
            <div class="cctv-content">
                <div class="video-container"><div class="tag">LIVE</div><div class="label">ğŸï¸ UDO (ç‰›å²›)</div><video id="v1" autoplay muted playsinline></video></div>
                <div class="video-container"><div class="tag">LIVE</div><div class="label">ğŸ”ï¸ HALLA (æ±‰æ‹¿å±±)</div><video id="v2" autoplay muted playsinline></video></div>
                <div class="video-container"><div class="tag">LIVE</div><div class="label">ğŸ›£ï¸ 1100 ROAD (é›ªæ™¯)</div><video id="v3" autoplay muted playsinline></video></div>
            </div>
        </div>

        <div id="card-daily" class="capture-card">
            <div class="weather-container">
                <div class="w-header"><span class="w-title">ä»Šæ—¥å¤©æ°” (Hourly)</span><span id="update-info-daily">Updating...</span></div>
                <div id="list-daily" class="w-content"></div> <footer>æµå·å²›å„åœ°åŒº 09:00-22:00 é¢„æŠ¥ | Source: KMA Short-term</footer>
            </div>
        </div>

        <div id="card-weekly" class="capture-card">
            <div class="weather-container">
                <div class="w-header">
                    <span class="w-title">ä¸­é•¿æœŸé¢„æŠ¥ (Today ~ 10 Days)</span>
                    <span id="update-info-weekly" style="font-size:12px; color:red;">Initializing...</span>
                </div>
                <div id="list-weekly" class="w-content"><div style="text-align:center; padding:100px; color:#999;">Waiting for Proxy...</div></div>
                <footer>Long-term Forecast | Source: KMA Short + Mid-term</footer>
            </div>
        </div>
    </div>

    <div class="link-footer">
        <button id="btn-install" class="btn" style="display:none; background:#e60023; color:white;"><span>ğŸ“² ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸°</span></button>
        <a href="https://jeju.go.kr/hallasan/index.htm" target="_blank" class="btn"><span>ğŸ”ï¸ æ±‰æ‹¿å±±æ¢è®¿</span></a>
        <a href="https://weather.naver.com/today/14000000" target="_blank" class="btn"><span>âš ï¸ æµå·æ°”è±¡ç‰¹æŠ¥</span></a>
        <a href="https://m.search.naver.com/search.naver?query=%EC%A0%9C%EC%A3%BC+%EC%9E%AC%EB%82%9C%EB%AC%B8%EC%9E%90" target="_blank" class="btn"><span>ğŸ“± æµå·ç¾éš¾çŸ­ä¿¡</span></a>
    </div>
    
    <!-- ë””ë²„ê·¸ìš© ë¡œê·¸ì°½ (ë¬¸ì œ ë°œìƒ ì‹œ ì›ì¸ íŒŒì•…ìš©) -->
    <div id="debug-log" style="width:100%; max-width:720px; background:#333; color:#0f0; padding:10px; font-size:10px; font-family:monospace; margin-top:20px; display:none;"></div>

<script>
    // ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜
    function log(msg) {
        console.log(msg);
        const d = document.getElementById('debug-log');
        if(d) {
            d.style.display = 'block';
            d.innerHTML += `<div>> ${msg}</div>`;
        }
    }

    // PWA ì„¤ì¹˜ ë²„íŠ¼ ë¡œì§
    let deferredPrompt;
    const installBtn = document.getElementById('btn-install');

    window.addEventListener('beforeinstallprompt', (e) => {
        // ë¸Œë¼ìš°ì € ê¸°ë³¸ ì„¤ì¹˜ ë°°ë„ˆ ë§‰ê¸°
        e.preventDefault();
        deferredPrompt = e;
        // ì„¤ì¹˜ ë²„íŠ¼ ë³´ì—¬ì£¼ê¸°
        installBtn.style.display = 'flex';
    });

    installBtn.addEventListener('click', (e) => {
        installBtn.style.display = 'none';
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
                console.log('User accepted the install prompt');
            }
            deferredPrompt = null;
        });
    });

    // 1. ì„¤ì •ê°’ ì •ì˜
    const MASTER_KEY = '05988a053767a7a6cc5553d077ce7ea541c60806a0160d5ac2e9119ebe5a61ce'; 
    const API_KEY = MASTER_KEY.trim(); 
    // â˜… í”„ë¡ì‹œ ì„œë²„ ì£¼ì†Œ: ë¸Œë¼ìš°ì € ë³´ì•ˆ(CORS)ì„ ìš°íšŒí•´ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê²Œ í•´ì¤ë‹ˆë‹¤.
    const PROXY = 'https://cors-anywhere.herokuapp.com/';

    // í˜„ì¬ ë‚ ì§œ êµ¬í•˜ê¸°
    const now = new Date();
    // [ìˆ˜ì • ë³µêµ¬] ì‹œìŠ¤í…œ ì‹œê°„ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš© (2026ë…„ ì •ìƒ ë™ì‘ í™•ì¸ë¨)
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth()+1).padStart(2,'0'); // 1ì›” -> 01ë¡œ ë³€í™˜
    const dd = String(now.getDate()).padStart(2,'0');
    const todayStr = yyyy + mm + dd;
    const zhDays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­']; // ìš”ì¼ í•œì ë°°ì—´

    // ë‚ ì§œë¥¼ YYYYMMDD í˜•íƒœë¡œ ë°”ê¿”ì£¼ëŠ” ë„ìš°ë¯¸ í•¨ìˆ˜
    function getFormatDate(date) {
        const y = date.getFullYear();
        const m = ('0' + (date.getMonth() + 1)).slice(-2);
        const d = ('0' + date.getDate()).slice(-2);
        return `${y}${m}${d}`;
    }

    // ===============================================
    // ê¸°ëŠ¥ 1: CCTV ì¬ìƒ (initCCTV)
    // ===============================================
    function initCCTV() {
        const streams = [
            { id: 'v1', url: 'http://211.114.96.121:1935/jejusi7/11-24.stream/chunklist_w1514884533.m3u8' },
            { id: 'v2', url: 'http://119.65.216.155:1935/live/cctv03.stream_360p/chunklist_w324217178.m3u8' },
            { id: 'v3', url: 'http://119.65.216.155:1935/live/cctv05.stream_360p/chunklist_w1064037964.m3u8' }
        ];
        // Hls.js ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì§€ì›ë˜ë©´ ì˜ìƒì„ ì—°ê²°í•©ë‹ˆë‹¤.
        if (Hls.isSupported()) {
            streams.forEach(stream => {
                const video = document.getElementById(stream.id);
                const hls = new Hls();
                hls.loadSource(stream.url); // ì˜ìƒ ì£¼ì†Œ ë¡œë“œ
                hls.attachMedia(video);     // ë¹„ë””ì˜¤ íƒœê·¸ì— ì—°ê²°
            });
        }
    }

    // ===============================================
    // ê¸°ëŠ¥ 2: ì˜¤ëŠ˜ ë‚ ì”¨ ì˜ˆë³´ (initDailyWeather)
    // ===============================================
    async function initDailyWeather() { 
        log("Init Daily Weather...");
        // ì§€ì—­ë³„ ì¢Œí‘œ ì„¤ì • (ê¸°ìƒì²­ ê·¸ë¦¬ë“œ ì¢Œí‘œ nx, ny)
        const locations = [
            { main: "æµå·å¸‚", sub: "è²æ´ (City)", nx: 52, ny: 38 },
            { main: "è¥¿å½’æµ¦", sub: "ä¸­æ–‡ (Jungmun)", nx: 52, ny: 32 },
            { main: "æ±‰æ‹¿å±±", sub: "å¨åŠ¿å²³ (Mt.Halla)", nx: 52, ny: 35 },
            { main: "ç‰›å²›", sub: "å¤©æ´¥æ¸¯ (Udo)", nx: 60, ny: 38 }
        ];

        // ê¸°ì¤€ ì‹œê°„ ì„¤ì •
        let baseDate = todayStr;
        let baseTime = "0200";
        if (now.getHours() < 2 || (now.getHours() === 2 && now.getMinutes() < 15)) {
            baseTime = "2300";
            // ì–´ì œ ë‚ ì§œ ê³„ì‚° (2025ë…„ ê¸°ì¤€)
            const yD = new Date(yyyy, now.getMonth(), now.getDate() - 1); 
            baseDate = getFormatDate(yD);
        }
        
        log(`Base: ${baseDate} ${baseTime}, TodayStr: ${todayStr}`);

        const listDiv = document.getElementById('list-daily');
        listDiv.innerHTML = ''; 
        
        let obsH = now.getHours();
        if (now.getMinutes() < 40) obsH -= 1; 
        if (obsH < 0) obsH = 23; 
        const obsTime = String(obsH).padStart(2,'0') + "00";

        for (const loc of locations) {
            let obsBadge = "Wait..";
            let gridHtml = '';
            
            // 2-1. í˜„ì¬ ì‹¤í™©
            try {
                const url = `${PROXY}https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getUltraSrtNcst?serviceKey=${API_KEY}&numOfRows=10&pageNo=1&dataType=JSON&base_date=${todayStr}&base_time=${obsTime}&nx=${loc.nx}&ny=${loc.ny}`;
                const res = await fetch(url);
                const json = await res.json();
                if(json.response.header.resultCode === '00'){
                    const obs = {};
                    json.response.body.items.item.forEach(i => obs[i.category] = i.obsrValue);
                    obsBadge = `NOW: ${obs.T1H}Â°C | ${obs.WSD}m/s`; 
                } else {
                    obsBadge = `Err:${json.response.header.resultMsg}`;
                }
            } catch(e) { obsBadge = "NCST Err"; }

            // 2-2. ì˜¤ëŠ˜ ì˜ˆë³´
            try {
                const url = `${PROXY}https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst?serviceKey=${API_KEY}&numOfRows=1000&pageNo=1&dataType=JSON&base_date=${baseDate}&base_time=${baseTime}&nx=${loc.nx}&ny=${loc.ny}`;
                const res = await fetch(url);
                const text = await res.text();
                
                if(text.trim().startsWith('<')) throw new Error('CORS/Auth Error (HTML returned)');
                
                const json = JSON.parse(text);
                if(json.response.header.resultCode === '00'){
                    const hourly = {};
                    json.response.body.items.item.forEach(item => {
                        if(item.fcstDate === todayStr) {
                            const h = parseInt(item.fcstTime.slice(0,2));
                            if(h >= 9 && h <= 22) {
                                if(!hourly[h]) hourly[h] = {};
                                hourly[h][item.category] = item.fcstValue;
                            }
                        }
                    });

                    // ë°ì´í„°ê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ì—ëŸ¬ í‘œì‹œ
                    if(Object.keys(hourly).length === 0) {
                        gridHtml = `<div style="padding:20px; color:orange;">No data for ${todayStr}. (System Date Issue?)</div>`;
                    } else {
                        for(let i=9; i<=22; i++){ 
                            const d = hourly[i] || {};
                            let icon = 'â˜€ï¸';
                            const pty = parseInt(d.PTY||0), sky = parseInt(d.SKY||1);
                            if(pty>0) icon = (pty===3)?'â„ï¸':'ğŸŒ§ï¸'; else if(sky===3) icon='ğŸŒ¤ï¸'; else if(sky===4) icon='â˜ï¸';
                            if(i>=19 && (icon==='â˜€ï¸'||icon==='ğŸŒ¤ï¸')) icon='ğŸŒ™';
                            
                            const pcp = (d.PCP==='ê°•ìˆ˜ì—†ìŒ')?'0':d.PCP;
                            gridHtml += `<div class="w-col"><div class="f-time">${i}h</div><div class="f-icon">${icon}</div><div class="f-temp">${d.TMP||'-'}<span class="unit">Â°</span></div><div class="f-wind">${d.WSD||'-'}<span class="unit">m/s</span></div><div class="f-rain">${pcp}<span class="unit">mm</span></div></div>`;
                        }
                    }
                } else {
                    throw new Error(json.response.header.resultMsg);
                }
            } catch(e) { 
                log(`Daily Err(${loc.main}): ${e.message}`);
                gridHtml = `<div style="padding:20px; color:red; font-size:11px;">Error: ${e.message}<br>Check Debug Log below.</div>`; 
            }
            
            listDiv.innerHTML += `<div class="loc-card"><div class="loc-header"><div><span class="loc-name">${loc.main}</span><span class="loc-sub">${loc.sub}</span></div><span class="loc-badge">${obsBadge}</span></div><div class="w-grid">${gridHtml}</div></div>`;
        }
        document.getElementById('update-info-daily').innerText = `${mm}.${dd} ${zhDays[now.getDay()]}`;
    }

    // ===============================================
    // ê¸°ëŠ¥ 3: ì£¼ê°„ ì˜ˆë³´ (initWeeklyWeather) - ì˜¤ëŠ˜ ~ 10ì¼ í›„
    // ===============================================
    async function initWeeklyWeather() {
        log("Init Weekly Weather...");
        const statusSpan = document.getElementById('update-info-weekly');
        const listDiv = document.getElementById('list-weekly');
        
        statusSpan.innerText = "Step 1/3 (Today-Day2)";
        
        const locations = [
            { name: "æµå·å¸‚", sub: "Jeju City", regIdTemp: '11G00201', regIdLand: '11G00000', nx: 52, ny: 38 }, 
            { name: "è¥¿å½’æµ¦", sub: "Seogwipo", regIdTemp: '11G00401', regIdLand: '11G00000', nx: 52, ny: 32 },
            { name: "æ±‰æ‹¿å±±", sub: "Mt. Halla", regIdTemp: '11G00401', regIdLand: '11G00000', nx: 52, ny: 35 },
            { name: "ç‰›å²›", sub: "Udo Island", regIdTemp: '11G00302', regIdLand: '11G00000', nx: 60, ny: 38 }
        ];

        // 1) ë‹¨ê¸°ì˜ˆë³´ ê¸°ì¤€ ì‹œê°„
        let shortBaseDate = todayStr;
        let shortBaseTime = "0200";
        if (now.getHours() < 2) {
             const yD = new Date(yyyy, now.getMonth(), now.getDate() - 1); // 2025 ê¸°ì¤€ ê³„ì‚°
             shortBaseDate = getFormatDate(yD);
             shortBaseTime = "2300";
        }

        // 2) ì¤‘ê¸°ì˜ˆë³´ ê¸°ì¤€ ì‹œê°„ (3ì¼~10ì¼ ë°ì´í„°ìš©)
        // í•˜ë£¨ 2íšŒ(06:00, 18:00) ë°œí‘œ. ì•ˆì „í•˜ê²Œ 2ì‹œê°„ ì—¬ìœ ë¥¼ ë‘ê³  ì´ì „ ë°ì´í„°ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.
        const h = now.getHours();
        let midTmFc;
        
        // 08ì‹œ ì´ì „ì´ë©´ -> ì–´ì œ 18:00 ë°ì´í„° ì‚¬ìš©
        if (h < 8) {
             const yD = new Date(yyyy, now.getMonth(), now.getDate() - 1);
             const yM = ('0'+(yD.getMonth()+1)).slice(-2);
             const yDate = ('0'+yD.getDate()).slice(-2);
             midTmFc = `${yD.getFullYear()}${yM}${yDate}1800`;
        }
        // 08ì‹œ ~ 20ì‹œ ì‚¬ì´ë©´ -> ì˜¤ëŠ˜ 06:00 ë°ì´í„° ì‚¬ìš©
        else if (h >= 8 && h < 20) {
            midTmFc = `${yyyy}${mm}${dd}0600`;
        }
        // 20ì‹œ ì´í›„ë©´ -> ì˜¤ëŠ˜ 18:00 ë°ì´í„° ì‚¬ìš©
        else {
            midTmFc = `${yyyy}${mm}${dd}1800`;
        }

        log(`ShortBase: ${shortBaseDate}, MidTmFc: ${midTmFc}`);

        let isFirst = true;

        for (const loc of locations) {
            let combinedData = {};
            
            // --- A. ë‹¨ê¸°ì˜ˆë³´ (0~2ì¼ì°¨) ---
            try {
                const urlS = `${PROXY}https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst?serviceKey=${API_KEY}&numOfRows=1000&pageNo=1&dataType=JSON&base_date=${shortBaseDate}&base_time=${shortBaseTime}&nx=${loc.nx}&ny=${loc.ny}`;
                const resS = await fetch(urlS);
                const textS = await resS.text();
                
                if(!textS.trim().startsWith('<')) {
                    const jsonS = JSON.parse(textS);
                    if(jsonS.response.header.resultCode === '00'){
                        const tempDays = {};
                        jsonS.response.body.items.item.forEach(it => {
                            const date = it.fcstDate;
                            if(!tempDays[date]) tempDays[date] = { min:100, max:-100, sky:1, pty:0, pop:0, temps:[] };
                            if(it.category === 'TMN') tempDays[date].min = parseFloat(it.fcstValue);
                            if(it.category === 'TMX') tempDays[date].max = parseFloat(it.fcstValue);
                            if(it.category === 'TMP') tempDays[date].temps.push(parseFloat(it.fcstValue));
                            if(it.category === 'POP') tempDays[date].pop = Math.max(tempDays[date].pop, parseInt(it.fcstValue));
                            if(it.category === 'PTY') tempDays[date].pty = Math.max(tempDays[date].pty, parseInt(it.fcstValue));
                            if(it.category === 'SKY') tempDays[date].sky = parseInt(it.fcstValue); 
                        });
                        
                        // [ìˆ˜ì •] ë‹¨ê¸°ì˜ˆë³´ê°€ ì´ì œ 3ì¼ í›„(ê¸€í”¼)ê¹Œì§€ ì»¤ë²„í•©ë‹ˆë‹¤. (ê¸°ì¡´ 0~2 -> 0~3ìœ¼ë¡œ í™•ì¥)
                        for(let i=0; i<=3; i++){
                            // ë‚ ì§œ ë”í•˜ê¸° (ì‹œìŠ¤í…œ ì‹œê°„ ê¸°ì¤€)
                            const d = new Date(yyyy, now.getMonth(), now.getDate() + i);
                            const dStr = getFormatDate(d);
                            const t = tempDays[dStr];
                            if(t) {
                                if(t.min === 100 && t.temps.length > 0) t.min = Math.min(...t.temps);
                                if(t.max === -100 && t.temps.length > 0) t.max = Math.max(...t.temps);
                                let wf = "ë§‘ìŒ";
                                if(t.pty > 0) { if(t.pty===3) wf="ëˆˆ"; else wf="ë¹„"; } 
                                else { if(t.sky===3) wf="êµ¬ë¦„ë§ìŒ"; else if(t.sky===4) wf="íë¦¼"; }
                                combinedData[i] = { min: t.min, max: t.max, wf: wf, pop: t.pop };
                            }
                        }
                    } else {
                        log(`Short(${loc.name}) API Error: ${jsonS.response.header.resultMsg}`);
                    }
                }
            } catch(e) { log(`Short(${loc.name}) Catch: ${e.message}`); }

            statusSpan.innerText = "Step 2/3 (Day3-10)";

            // --- B. ì¤‘ê¸°ì˜ˆë³´ (3~10ì¼ì°¨) ---
            try {
                const urlT = `${PROXY}https://apis.data.go.kr/1360000/MidFcstInfoService/getMidTa?serviceKey=${API_KEY}&numOfRows=1&pageNo=1&dataType=JSON&regId=${loc.regIdTemp}&tmFc=${midTmFc}`;
                const resT = await fetch(urlT);
                const textT = await resT.text();
                
                if(!textT.trim().startsWith('<')) {
                    const jsonT = JSON.parse(textT);
                    if(jsonT.response.header.resultCode === '00') {
                        const tItem = jsonT.response.body.items.item[0];
                        
                        const urlL = `${PROXY}https://apis.data.go.kr/1360000/MidFcstInfoService/getMidLandFcst?serviceKey=${API_KEY}&numOfRows=1&pageNo=1&dataType=JSON&regId=${loc.regIdLand}&tmFc=${midTmFc}`;
                        const resL = await fetch(urlL);
                        const jsonL = await resL.json();
                        if(jsonL.response.header.resultCode === '00') {
                            const lItem = jsonL.response.body.items.item[0];
                            log(`Mid Land Data(Sample): wf3Am=${lItem.wf3Am}, wf3Pm=${lItem.wf3Pm}`);
                            
                            // [ìˆ˜ì •] ì¤‘ê¸°ì˜ˆë³´ëŠ” 4ì¼ë¶€í„° 10ì¼ê¹Œì§€ ì²˜ë¦¬ (3ì¼ì€ ë‹¨ê¸°ì˜ˆë³´ì—ì„œ ì²˜ë¦¬ë¨)
                            for(let i=4; i<=10; i++) {
                                // 1. ë‚ ì”¨ ìƒíƒœ (ë§‘ìŒ/íë¦¼ ë“±) - ì˜¤í›„ ìš°ì„ , ì—†ìœ¼ë©´ ì˜¤ì „
                                let wf = lItem[`wf${i}Pm`] || lItem[`wf${i}Am`] || lItem[`wf${i}`];
                                
                                // 2. ê°•ìˆ˜ í™•ë¥  - ì˜¤í›„ ìš°ì„ , ì—†ìœ¼ë©´ ì˜¤ì „
                                let pop = lItem[`rnSt${i}Pm`];
                                if (pop === undefined) pop = lItem[`rnSt${i}Am`];
                                if (pop === undefined) pop = lItem[`rnSt${i}`];

                                combinedData[i] = {
                                    min: tItem[`taMin${i}`], 
                                    max: tItem[`taMax${i}`],
                                    wf: wf, 
                                    pop: pop
                                };
                            }
                        }
                    } else {
                         log(`Mid(${loc.name}) API Error: ${jsonT.response.header.resultMsg}`);
                    }
                }
            } catch(e) { log(`Mid(${loc.name}) Catch: ${e.message}`); }

            statusSpan.innerText = "Step 3/3 (Rendering)";

            if(isFirst) { listDiv.innerHTML = ''; isFirst = false; }

            // --- C. í™”ë©´ ê·¸ë¦¬ê¸° ---
            let gridHtml = '';
            // ë°ì´í„°ê°€ ì—†ì–´ë„ ìµœëŒ€ 10ì¼ê¹Œì§€ ë¹ˆì¹¸ì´ë¼ë„ ê·¸ë¦¼ (ë ˆì´ì•„ì›ƒ ê¹¨ì§ ë°©ì§€)
            for(let i=0; i<=10; i++) {
                const d = new Date(yyyy, now.getMonth(), now.getDate() + i);
                const label = (i===0) ? "Today" : `${d.getMonth()+1}/${d.getDate()}`;
                const w = combinedData[i] || { wf: '-', min: '-', max: '-', pop: '-' };
                
                const wf = w.wf || "-";
                let icon = 'â“'; // ë°ì´í„° ì—†ìŒ
                if(wf.includes('ë§‘ìŒ')) icon = 'â˜€ï¸';
                else if(wf.includes('íë¦¼')) icon = 'â˜ï¸'; 
                else if(wf.includes('êµ¬ë¦„') || wf.includes('ë§ìŒ')) icon = 'â›…'; 
                else if(wf.includes('ë¹„')) icon = 'ğŸŒ§ï¸'; 
                else if(wf.includes('ëˆˆ')) icon = 'â„ï¸'; 
                else if(wf.includes('ì†Œë‚˜ê¸°')) icon = 'ğŸŒ¦ï¸';
                else if(wf === '-') icon = 'â“';

                const minT = (w.min !== undefined && w.min !== 100 && w.min !== '-') ? w.min : '-';
                const maxT = (w.max !== undefined && w.max !== -100 && w.max !== '-') ? w.max : '-';
                const pop = (w.pop !== undefined && w.pop !== '-') ? w.pop : 0;

                gridHtml += `
                <div class="w-col">
                    <div class="f-time">${label}<br><span style="font-size:9px; font-weight:400; color:#999;">+${i}D</span></div>
                    <div class="f-icon">${icon}</div>
                    <div class="f-temp">
                        <span class="t-high">${maxT}Â°</span><span style="color:#ddd; margin:0 2px;">/</span><span class="t-low">${minT}Â°</span>
                    </div>
                    <div class="f-rain pop-blue">${pop}<span class="unit">%</span></div>
                </div>`;
            }
            listDiv.innerHTML += `<div class="loc-card"><div class="loc-header"><span class="loc-name">${loc.name}</span><span class="loc-sub" style="font-size:9px;">${loc.sub}</span></div><div class="w-grid">${gridHtml}</div></div>`;
        }
        statusSpan.innerText = "Updated";
    }

    // í•¨ìˆ˜ ì‹¤í–‰ ì‹œì‘
    initCCTV();
    initDailyWeather();
    setTimeout(initWeeklyWeather, 1000); // 1ì´ˆ ë’¤ì— ì£¼ê°„ì˜ˆë³´ ì‹¤í–‰ (ë¶€í•˜ ë¶„ì‚°)

    // PWA Service Worker ë“±ë¡
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful');
                })
                .catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
        });
    }
</script>
</body>
</html>
