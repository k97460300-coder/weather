<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æµå·å²›å¤©æ°” - é™æ°´é‡</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body {
            margin: 0; padding: 10px; background-color: #f0f2f5;
            display: flex; flex-direction: column; align-items: center;
            font-family: 'Noto Sans SC', sans-serif; min-height: 100vh; color: #333;
        }
        .container { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 15px; padding-bottom: 40px; }
        .card { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .card-header {
            background: #fff; padding: 12px 15px; border-bottom: 1px solid #eee;
            font-weight: 800; font-size: 16px; color: #1a1a1a; display: flex; justify-content: space-between; align-items: center;
        }
        .badge { font-size: 11px; padding: 3px 8px; border-radius: 12px; background: #e8f5e9; color: #2e7d32; font-weight: bold; }

        /* CCTV Section */
        .video-box { position: relative; width: 100%; aspect-ratio: 16/9; background: #000; border-bottom: 1px solid #222; }
        .live-tag { position: absolute; top: 10px; left: 10px; background: #ff5252; color: white; padding: 2px 6px; font-size: 10px; border-radius: 3px; z-index: 10; animation: blink 1.5s infinite; font-weight: bold; }
        .vid-label { position: absolute; bottom: 8px; left: 10px; color: white; font-weight: bold; font-size: 14px; text-shadow: 1px 1px 4px rgba(0,0,0,0.8); z-index: 10; }
        video { width: 100%; height: 100%; object-fit: cover; }
        @keyframes blink { 0%, 100% {opacity: 1;} 50% {opacity: 0.6;} }

        /* Weather Section */
        .weather-section { padding: 15px; border-bottom: 8px solid #f0f2f5; }
        .weather-section:last-child { border-bottom: none; }
        .loc-info { margin-bottom: 12px; }
        .loc-name { font-size: 18px; font-weight: 900; color: #1a1a1a; }
        .loc-sub { font-size: 12px; color: #666; margin-left: 5px; font-weight: 500; }

        .grid { display: flex; flex-wrap: wrap; gap: 0; }
        .col {
            width: 14.28%; display: flex; flex-direction: column; align-items: center; margin-bottom: 12px;
        }
        /* ì£¼ê°„ ì˜ˆë³´ëŠ” 7ì¼ì¹˜(4~10ì¼)ë¥¼ ë³´ì—¬ì£¼ë¯€ë¡œ 7ë“±ë¶„ */
        .weekly-grid .col { width: 14.28%; margin-bottom: 18px; }

        .time { font-size: 11px; color: #757575; font-weight: bold; margin-bottom: 3px; }
        .icon { font-size: 22px; margin-bottom: 2px; }
        .temp { font-size: 14px; font-weight: 900; color: #212121; }
        .wind { font-size: 9px; color: #0288d1; font-weight: 600; margin-top: 1px; }
        .precip { font-size: 10px; color: #546e7a; font-weight: 500; }

        .high { color: #d32f2f; } .low { color: #1976d2; }
        .precip-blue { color: #1e88e5; font-weight: bold; }

        footer { text-align: center; padding: 20px; font-size: 11px; color: #999; }
        
        /* CORS Alert */
        .cors-alert { 
            width: 100%; max-width: 600px; background: #ff4d4f; color: white; 
            padding: 10px; margin-bottom: 10px; text-align: center; border-radius: 8px; 
            font-weight: bold; cursor: pointer; text-decoration: none; display: block; font-size: 12px;
        }
    </style>
</head>
<body>
    <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank" class="cors-alert">
        âš ï¸ [Click] Request temporary access (CORS) -> Then Refresh
    </a>

    <div class="container">
        <!-- CCTV -->
        <div class="card" style="background:#000;">
            <div class="card-header" style="background:#ff5252; color:#fff; border:none;">ğŸ”´ æµå·å²›å®å†µ (Live CCTV)</div>
            <div class="video-box"><div class="live-tag">LIVE</div><div class="vid-label">ğŸï¸ ç‰›å²› (Udo - å¤©æ´¥æ¸¯)</div><video id="v1" autoplay muted playsinline></video></div>
            <div class="video-box"><div class="live-tag">LIVE</div><div class="vid-label">ğŸ”ï¸ æ±‰æ‹¿å±± (Mt.Halla - å¨åŠ¿å²³)</div><video id="v2" autoplay muted playsinline></video></div>
            <div class="video-box"><div class="live-tag">LIVE</div><div class="vid-label">ğŸ›£ï¸ 1100é«˜åœ°é“è·¯ (é›ªæ™¯)</div><video id="v3" autoplay muted playsinline></video></div>
        </div>

        <!-- Daily Forecast -->
        <div class="card">
            <div class="card-header">â˜€ï¸ ä»Šæ—¥é€æ—¶é¢„æŠ¥ (Hourly) <span class="badge" id="date-label"></span></div>
            <div id="daily-list">
                <div style="padding:40px; text-align:center; color:#999; font-size:12px;">æ­£åœ¨è·å–å®æ—¶å¤©æ°”æ•°æ®...</div>
            </div>
        </div>

        <!-- Weekly Forecast (Combined Short+Mid) -->
        <div class="card">
            <div class="card-header">ğŸ“… æœªæ¥10å¤©é•¿æœŸé¢„æŠ¥ <span class="badge" id="weekly-status">Updating</span></div>
            <div id="weekly-list">
                <div style="padding:40px; text-align:center; color:#999; font-size:12px;">æ­£åœ¨è·å–é•¿æœŸé¢„æŠ¥æ•°æ®...</div>
            </div>
        </div>

        <footer>Data provided by Korea Meteorological Administration</footer>
    </div>
    
    <!-- Debug Log -->
    <div id="debug-log" style="width:100%; max-width:600px; background:#333; color:#0f0; padding:10px; font-size:10px; font-family:monospace; margin-top:20px; display:none; word-break: break-all;"></div>

<script>
    function log(msg) {
        console.log(msg);
        const d = document.getElementById('debug-log');
        if(d) {
            d.style.display = 'block';
            d.innerHTML += `<div>> ${msg}</div>`;
        }
    }

    const MASTER_KEY = '05988a053767a7a6cc5553d077ce7ea541c60806a0160d5ac2e9119ebe5a61ce'; 
    const API_KEY = MASTER_KEY.trim(); 
    const PROXY = 'https://cors-anywhere.herokuapp.com/';

    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth()+1).padStart(2,'0'); 
    const dd = String(now.getDate()).padStart(2,'0');
    const todayStr = yyyy + mm + dd;
    
    document.getElementById('date-label').innerText = `${now.getMonth()+1}æœˆ${now.getDate()}æ—¥`;

    function getFormatDate(date) {
        const y = date.getFullYear();
        const m = ('0' + (date.getMonth() + 1)).slice(-2);
        const d = ('0' + date.getDate()).slice(-2);
        return `${y}${m}${d}`;
    }

    function initCCTV() {
        const streams = [
            { id: 'v1', url: 'http://211.114.96.121:1935/jejusi7/11-24.stream/chunklist_w1514884533.m3u8' },
            { id: 'v2', url: 'http://119.65.216.155:1935/live/cctv03.stream_360p/chunklist_w324217178.m3u8' },
            { id: 'v3', url: 'http://119.65.216.155:1935/live/cctv05.stream_360p/chunklist_w1064037964.m3u8' }
        ];
        if (Hls.isSupported()) {
            streams.forEach(s => {
                const v = document.getElementById(s.id);
                // [ìˆ˜ì •] HLS ì„¤ì • ì¶”ê°€: ë””ë²„ê·¸ ë° ë¡œë”© ì •ì±… ì™„í™”
                const config = {
                    debug: false,
                    enableWorker: true,
                    lowLatencyMode: true,
                    backBufferLength: 90
                };
                const h = new Hls(config); 
                h.loadSource(s.url); 
                h.attachMedia(v);
                h.on(Hls.Events.ERROR, function(e,d){ 
                    if(d.fatal) {
                        log(`CCTV Error(${s.id}): ${d.type}`);
                        switch(d.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                h.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                h.recoverMediaError();
                                break;
                            default:
                                h.destroy();
                                break;
                        }
                    }
                });
            });
        }
    }

    async function initDaily() {
        const locs = [
            {n:"æµå·å¸‚ (è²æ´)", sub:"Yeon-dong", x:52, y:38},
            {n:"è¥¿å½’æµ¦ (ä¸­æ–‡)", sub:"Jungmun", x:52, y:32},
            {n:"æ±‰æ‹¿å±±", sub:"Mt.Halla", x:52, y:35},
            {n:"ç‰›å²›", sub:"Udo Island", x:60, y:38}
        ];
        
        let baseDate = todayStr;
        let baseTime = "0200";
        if (now.getHours() < 2 || (now.getHours() === 2 && now.getMinutes() < 15)) {
            baseTime = "2300";
            const yD = new Date(yyyy, now.getMonth(), now.getDate() - 1); 
            baseDate = getFormatDate(yD);
        }

        const container = document.getElementById('daily-list');
        container.innerHTML = '';

        for (const loc of locs) {
            try {
                const url = `${PROXY}https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst?serviceKey=${API_KEY}&numOfRows=1000&pageNo=1&dataType=JSON&base_date=${baseDate}&base_time=${baseTime}&nx=${loc.x}&ny=${loc.y}`;
                const res = await fetch(url);
                const json = await res.json();
                
                const hourly = {};
                if(json.response.header.resultCode === '00'){
                    json.response.body.items.item.forEach(i => {
                        if (i.fcstDate === todayStr) {
                            const h = parseInt(i.fcstTime.slice(0,2));
                            if(h>=9 && h<=22) {
                                if(!hourly[h]) hourly[h] = {};
                                hourly[h][i.category] = i.fcstValue;
                            }
                        }
                    });

                    let html = '';
                    for(let h=9; h<=22; h++) {
                        const d = hourly[h] || {};
                        let icon = 'â˜€ï¸';
                        const pty=parseInt(d.PTY||0), sky=parseInt(d.SKY||1);
                        if(pty>0) icon=(pty===3)?'â„ï¸':'ğŸŒ§ï¸'; else if(sky>8) icon='â˜ï¸'; else if(sky>5) icon='â›…';
                        if(h>=19 && (icon==='â˜€ï¸'||icon==='â›…')) icon='ğŸŒ™';

                        // ê°•ìˆ˜ëŸ‰(PCP) ì²˜ë¦¬
                        let pcp = d.PCP || '0';
                        if (pcp === "ê°•ìˆ˜ì—†ìŒ") {
                            pcp = "0mm";
                        } else if (pcp.includes("ë¯¸ë§Œ")) { 
                            // "1mm ë¯¸ë§Œ", "1.0mm ë¯¸ë§Œ" ë“± ì²˜ë¦¬
                            pcp = "~1mm";
                        } else if (!pcp.endsWith("mm")) {
                            // ìˆ«ìë§Œ ìˆëŠ” ê²½ìš° ë‹¨ìœ„ ë¶™ì„
                            pcp += "mm";
                        }

                        html += `<div class="col">
                            <div class="time">${h}h</div>
                            <div class="icon">${icon}</div>
                            <div class="temp">${d.TMP||'-'}Â°</div>
                            <div class="wind">${d.WSD||'-'}m/s</div>
                            <div class="precip ${pcp!=='0mm'?'precip-blue':''}">${pcp}</div>
                        </div>`;
                    }
                    container.innerHTML += `<div class="weather-section">
                        <div class="loc-info"><span class="loc-name">${loc.n}</span><span class="loc-sub">${loc.sub}</span></div>
                        <div class="grid">${html}</div>
                    </div>`;
                }
            } catch(e) { log(e.message); }
        }
    }

    async function initWeekly() {
        log("Start initWeekly");
        const container = document.getElementById('weekly-list');
        const statusSpan = document.getElementById('weekly-status');
        
        const locs = [
            { name: "æµå·å¸‚", sub: "Jeju City", regIdTemp: '11G00201', regIdLand: '11G00000', nx:52, ny:38 },
            { name: "è¥¿å½’æµ¦", sub: "Seogwipo", regIdTemp: '11G00401', regIdLand: '11G00000', nx:52, ny:32 },
            { name: "æ±‰æ‹¿å±±", sub: "Mt.Halla", regIdTemp: '11G00401', regIdLand: '11G00000', nx:52, ny:35 },
            { name: "ç‰›å²›", sub: "Udo Island", regIdTemp: '11G00302', regIdLand: '11G00000', nx:60, ny:38 }
        ];

        // 1) ë‹¨ê¸°ì˜ˆë³´ìš© (Short: 0~3ì¼)
        let shortBaseDate = todayStr;
        let shortBaseTime = "0200";
        if (now.getHours() < 2) {
             const yD = new Date(yyyy, now.getMonth(), now.getDate() - 1);
             shortBaseDate = getFormatDate(yD);
             shortBaseTime = "2300";
        }

        // 2) ì¤‘ê¸°ì˜ˆë³´ìš© (Mid: 4~10ì¼)
        const h = now.getHours();
        let midTmFc;
        if (h < 8) {
             const yD = new Date(yyyy, now.getMonth(), now.getDate() - 1);
             const yM = ('0'+(yD.getMonth()+1)).slice(-2);
             const yDate = ('0'+yD.getDate()).slice(-2);
             midTmFc = `${yD.getFullYear()}${yM}${yDate}1800`;
        } else if (h >= 8 && h < 20) { midTmFc = `${todayStr}0600`; }
        else { midTmFc = `${todayStr}1800`; }

        container.innerHTML = '';

        log(`ShortBase: ${shortBaseDate}, MidTmFc: ${midTmFc}`);

        let isFirst = true;

        for (const loc of locs) {
            log(`Processing ${loc.name}...`);
            let combinedData = {};
            
            // A. ë‹¨ê¸°ì˜ˆë³´ (0~3ì¼)
            try {
                const urlS = `${PROXY}https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst?serviceKey=${API_KEY}&numOfRows=1000&pageNo=1&dataType=JSON&base_date=${shortBaseDate}&base_time=${shortBaseTime}&nx=${loc.nx}&ny=${loc.ny}`;
                const resS = await fetch(urlS); const jsonS = await resS.json();
                
                if(jsonS.response && jsonS.response.header.resultCode === '00'){
                    const tempDays = {};
                    jsonS.response.body.items.item.forEach(it => {
                        const date = it.fcstDate;
                        if(!tempDays[date]) tempDays[date] = { min:100, max:-100, sky:1, pty:0, pop:0, temps:[] };
                        if(it.category === 'TMN') tempDays[date].min = parseFloat(it.fcstValue);
                        if(it.category === 'TMX') tempDays[date].max = parseFloat(it.fcstValue);
                        if(it.category === 'TMP') tempDays[date].temps.push(parseFloat(it.fcstValue));
                        if(it.category === 'POP') tempDays[date].pop = Math.max(tempDays[date].pop, parseInt(it.fcstValue));
                        if(it.category === 'PTY') tempDays[date].pty = Math.max(tempDays[date].pty, parseInt(it.fcstValue));
                        if(it.category === 'SKY') tempDays[date].sky = parseInt(it.fcstValue); 
                    });
                    
                    for(let i=0; i<=3; i++){
                        const d = new Date(yyyy, now.getMonth(), now.getDate() + i);
                        const dStr = getFormatDate(d);
                        const t = tempDays[dStr];
                        if(t) {
                            if(t.min === 100 && t.temps.length > 0) t.min = Math.min(...t.temps);
                            if(t.max === -100 && t.temps.length > 0) t.max = Math.max(...t.temps);
                            let wf = "ë§‘ìŒ";
                            if(t.pty > 0) { if(t.pty===3) wf="ëˆˆ"; else wf="ë¹„"; } 
                            else { if(t.sky===3) wf="êµ¬ë¦„ë§ìŒ"; else if(t.sky===4) wf="íë¦¼"; }
                            combinedData[i] = { min: t.min, max: t.max, wf: wf, pop: t.pop };
                        }
                    }
                } else {
                    log(`Short API Fail: ${jsonS.response.header.resultMsg}`);
                }
            } catch(e) { log(`Short API Error: ${e.message}`); }

            // B. ì¤‘ê¸°ì˜ˆë³´ (4~10ì¼)
            try {
                const urlT = `${PROXY}https://apis.data.go.kr/1360000/MidFcstInfoService/getMidTa?serviceKey=${API_KEY}&numOfRows=1&pageNo=1&dataType=JSON&regId=${loc.regIdTemp}&tmFc=${midTmFc}`;
                const resT = await fetch(urlT); const jsonT = await resT.json();
                
                const urlL = `${PROXY}https://apis.data.go.kr/1360000/MidFcstInfoService/getMidLandFcst?serviceKey=${API_KEY}&numOfRows=1&pageNo=1&dataType=JSON&regId=${loc.regIdLand}&tmFc=${midTmFc}`;
                const resL = await fetch(urlL); const jsonL = await resL.json();

                if(jsonT.response && jsonL.response && jsonT.response.header.resultCode === '00' && jsonL.response.header.resultCode === '00') {
                    const t = jsonT.response.body.items.item[0];
                    const l = jsonL.response.body.items.item[0];
                    
                    // [Debug] 4ì¼ì°¨ ë°ì´í„° í™•ì¸
                    log(`[Mid] Day4 Raw: Min=${t.taMin4}, Max=${t.taMax4}, WfPm=${l.wf4Pm}, WfAm=${l.wf4Am}`);

                    for(let i=4; i<=10; i++) {
                        let wf = l[`wf${i}Pm`] || l[`wf${i}Am`] || l[`wf${i}`];
                        let pop = l[`rnSt${i}Pm`];
                        if (pop === undefined) pop = l[`rnSt${i}Am`];
                        if (pop === undefined) pop = l[`rnSt${i}`];
                        
                        combinedData[i] = {
                            min: t[`taMin${i}`], max: t[`taMax${i}`],
                            wf: wf, pop: pop
                        };
                    }
                } else {
                    log("Mid API Fail or No Data");
                }
            } catch(e) { log(`Mid API Error: ${e.message}`); }

            // C. ë Œë”ë§
            let html = '';
            for(let i=0; i<=10; i++) {
                const d = new Date(yyyy, now.getMonth(), now.getDate() + i);
                const label = `${d.getMonth()+1}/${d.getDate()}`;
                const w = combinedData[i] || { wf: '-', min: '-', max: '-', pop: '-' };
                
                const wf = w.wf || "-";
                let icon = 'â˜€ï¸';
                if(wf.includes('íë¦¼')) icon='â˜ï¸';
                else if(wf.includes('êµ¬ë¦„') || wf.includes('ë§ìŒ')) icon='â›…';
                else if(wf.includes('ë¹„')) icon='ğŸŒ§ï¸';
                else if(wf.includes('ëˆˆ')) icon='â„ï¸';

                const minT = (w.min !== undefined && w.min !== 100) ? w.min : '-';
                const maxT = (w.max !== undefined && w.max !== -100) ? w.max : '-';
                const pop = (w.pop !== undefined) ? w.pop : 0;

                html += `<div class="col">
                    <div class="time">${label}<br><span style="font-size:9px; color:#aaa;">+${i}D</span></div>
                    <div class="icon">${icon}</div>
                    <div class="temp"><span class="high">${maxT}</span>/<span class="low">${minT}</span></div>
                    <div class="precip ${pop>0?'precip-blue':''}">${pop}%</div>
                </div>`;
            }
            container.innerHTML += `<div class="weather-section">
                <div class="loc-info"><span class="loc-name">${loc.name}</span><span class="loc-sub">${loc.sub}</span></div>
                <div class="grid weekly-grid">${html}</div>
            </div>`;
        }
        statusSpan.innerText = "";
    }

    initCCTV();
    initDaily();
    setTimeout(initWeekly, 2000);
</script>
</body>
</html>
