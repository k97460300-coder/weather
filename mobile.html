<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jeju Mobile Weather</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        /* ëª¨ë°”ì¼ ìµœì í™”ëœ CSS */
        body {
            margin: 0; padding: 10px; background-color: #222;
            display: flex; flex-direction: column; align-items: center;
            font-family: 'Noto Sans SC', sans-serif; min-height: 100vh;
            color: #333;
        }
        .dashboard-container {
            display: flex; flex-direction: column; width: 100%; max-width: 600px; gap: 20px; padding-bottom: 30px;
        }
        .capture-card {
            width: 100%; background: #fff; border-radius: 16px; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: flex; flex-direction: column;
        }

        /* CORS ë²„íŠ¼ */
        .cors-alert {
            width: 95%; max-width: 600px; background: #ff4d4f; color: white;
            padding: 12px; margin-bottom: 20px; text-align: center; border-radius: 10px;
            font-weight: bold; font-size: 13px; text-decoration: none; display: block;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% {transform: scale(0.98);} 50% {transform: scale(1.02);} 100% {transform: scale(0.98);} }

        /* CCTV ìŠ¤íƒ€ì¼ */
        #card-cctv { background: #000; border: 1px solid #333; }
        .cctv-header { padding: 15px; background: linear-gradient(90deg, #ff8c00, #ff0080); color: white; text-align: center; font-size: 20px; font-weight: 900; }
        .cctv-content { display: flex; flex-direction: column; gap: 2px; background: #111; }
        .video-container { width: 100%; aspect-ratio: 16/9; position: relative; background: #000; border-bottom: 1px solid #333; }
        .tag { position: absolute; top: 10px; left: 10px; background: rgba(220,0,0,0.9); color: white; padding: 4px 8px; font-weight: bold; border-radius: 4px; font-size: 11px; z-index: 20; animation: blink 2s infinite; }
        .label { position: absolute; bottom: 10px; left: 10px; text-shadow: 1px 1px 3px rgba(0,0,0,0.9); color: #fff; font-size: 16px; font-weight: 800; z-index: 10; }
        video { width: 100%; height: 100%; object-fit: cover; }
        @keyframes blink { 0% {opacity: 1;} 50% {opacity: 0.7;} 100% {opacity: 1;} }

        /* ë‚ ì”¨ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .weather-container { padding: 20px 15px; display: flex; flex-direction: column; }
        .w-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 14px; color: #888; font-weight: 600; }
        .w-title { font-size: 20px; font-weight: 900; color: #000; }
        .w-content { display: flex; flex-direction: column; gap: 12px; }

        .loc-card { border: 1px solid #eee; border-radius: 12px; padding: 12px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .loc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .loc-name { font-size: 17px; font-weight: 800; color: #222; }
        .loc-sub { font-size: 12px; color: #888; margin-left: 5px; }
        .loc-badge { font-size: 11px; font-weight: 700; padding: 3px 6px; border-radius: 4px; background: #fff2f1; color: #d93025; border: 1px solid #ffa39e; }

        /* ê°€ë¡œ ìŠ¤í¬ë¡¤ Grid */
        .w-grid {
            display: flex; gap: 0; overflow-x: auto; padding-top: 5px; padding-bottom: 5px;
            border-top: 1px solid #f1f3f5;
            scrollbar-width: none; -webkit-overflow-scrolling: touch;
        }
        .w-grid::-webkit-scrollbar { display: none; }

        .w-col {
            display: flex; flex-direction: column; align-items: center; text-align: center;
            min-width: 52px; flex-shrink: 0;
        }

        .f-time { font-size: 11px; color: #666; font-weight: 700; margin-bottom: 3px; line-height: 1.2; }
        .f-icon { font-size: 18px; margin-bottom: 2px; }
        .f-temp { font-size: 12px; font-weight: 800; color: #000; }
        .f-rain { font-size: 9px; color: #888; font-weight: 500; }
        .t-high { color: #ff4d4f; }
        .t-low { color: #1a73e8; }
        .pop-blue { color: #339af0; font-weight: 700; }

        footer { text-align: center; margin-top: 10px; font-size: 11px; color: #ccc; }
    </style>
</head>
<body>
    <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank" class="cors-alert">
        âš ï¸ 1. ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ì„œ [Request temporary access] ë²„íŠ¼ì„ ê¼­ ëˆ„ë¥´ì„¸ìš”!<br>
        (ëˆ„ë¥¸ ë’¤ ë’¤ë¡œê°€ê¸° í•´ì„œ ìƒˆë¡œê³ ì¹¨ í•˜ì„¸ìš”)
    </a>

    <div class="dashboard-container">
        <div id="card-cctv" class="capture-card">
            <div class="cctv-header">JEJU LIVE NOW ğŸ”´</div>
            <div class="cctv-content">
                <div class="video-container">
                    <div class="tag">LIVE</div>
                    <div class="label">ğŸï¸ UDO (ç‰›å²›)</div>
                    <video id="v1" autoplay muted playsinline></video>
                </div>
                <div class="video-container">
                    <div class="tag">LIVE</div>
                    <div class="label">ğŸ”ï¸ HALLA (æ±‰æ‹¿å±±)</div>
                    <video id="v2" autoplay muted playsinline></video>
                </div>
                <div class="video-container">
                    <div class="tag">LIVE</div>
                    <div class="label">ğŸ›£ï¸ 1100 ROAD</div>
                    <video id="v3" autoplay muted playsinline></video>
                </div>
            </div>
        </div>

        <div class="capture-card">
            <div class="weather-container">
                <div class="w-header"><span class="w-title">ä»Šæ—¥å¤©æ°” (Hourly)</span><span id="update-info-daily">Updating...</span></div>
                <div id="list-daily" class="w-content"></div>
                <footer>09:00 ~ 22:00 Forecast</footer>
            </div>
        </div>

        <div class="capture-card">
            <div class="weather-container">
                <div class="w-header">
                    <span class="w-title">ä¸­é•¿æœŸé¢„æŠ¥ (10 Days)</span>
                    <span id="update-info-weekly" style="font-size:11px; color:red;">Init...</span>
                </div>
                <div id="list-weekly" class="w-content">
                    <div style="text-align:center; padding:20px; color:#999;">Waiting for Access...</div>
                </div>
            </div>
        </div>
    </div>

<script>
    // === 1. ì„¤ì • ===
    const API_KEY = '05988a053767a7a6cc5553d077ce7ea541c60806a0160d5ac2e9119ebe5a61ce';
    const PROXY = 'https://cors-anywhere.herokuapp.com/';
    const now = new Date();

    // ë‚ ì§œ í¬ë§· í•¨ìˆ˜
    function getFormatDate(date) {
        const y = date.getFullYear();
        const m = ('0' + (date.getMonth() + 1)).slice(-2);
        const d = ('0' + date.getDate()).slice(-2);
        return `${y}${m}${d}`;
    }
    const todayStr = getFormatDate(now);

    // === 2. CCTV ê¸°ëŠ¥ ===
    function initCCTV() {
        const streams = [
            { id: 'v1', url: 'http://211.114.96.121:1935/jejusi7/11-24.stream/chunklist_w1514884533.m3u8' },
            { id: 'v2', url: 'http://119.65.216.155:1935/live/cctv03.stream_360p/chunklist_w324217178.m3u8' },
            { id: 'v3', url: 'http://119.65.216.155:1935/live/cctv05.stream_360p/chunklist_w1064037964.m3u8' }
        ];
        if (Hls.isSupported()) {
            streams.forEach(s => {
                const video = document.getElementById(s.id);
                const hls = new Hls();
                hls.loadSource(s.url);
                hls.attachMedia(video);
                // ìë™ ì¬ìƒ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë¡œì§
                hls.on(Hls.Events.ERROR, function(event, data) {
                    if (data.fatal) {
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR: hls.startLoad(); break;
                            case Hls.ErrorTypes.MEDIA_ERROR: hls.recoverMediaError(); break;
                            default: hls.destroy(); break;
                        }
                    }
                });
            });
        }
    }

    // === 3. ì˜¤ëŠ˜ ë‚ ì”¨ (09~22ì‹œ) ===
    async function initDailyWeather() {
        const locations = [
            { main: "æµå·å¸‚", sub: "Jeju", nx: 52, ny: 38 },
            { main: "è¥¿å½’æµ¦", sub: "Jungmun", nx: 52, ny: 32 },
            { main: "æ±‰æ‹¿å±±", sub: "Mt.Halla", nx: 52, ny: 35 },
            { main: "ç‰›å²›", sub: "Udo", nx: 60, ny: 38 }
        ];

        let baseDate = todayStr;
        let baseTime = "0200";
        if (now.getHours() < 2) { // ìƒˆë²½ 2ì‹œ ì´ì „ì´ë©´ ì–´ì œ 23ì‹œ ë°ì´í„° ì‚¬ìš©
            const yD = new Date(now); yD.setDate(now.getDate() - 1);
            baseDate = getFormatDate(yD);
            baseTime = "2300";
        }

        const listDiv = document.getElementById('list-daily');
        listDiv.innerHTML = '';
        document.getElementById('update-info-daily').innerText = `${now.getMonth()+1}.${now.getDate()}`;

        for (const loc of locations) {
            let gridHtml = '';
            try {
                const url = `${PROXY}https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst?serviceKey=${API_KEY}&numOfRows=1000&pageNo=1&dataType=JSON&base_date=${baseDate}&base_time=${baseTime}&nx=${loc.nx}&ny=${loc.ny}`;
                const res = await fetch(url);
                const json = await res.json();

                if(json.response.header.resultCode === '00'){
                    const hourly = {};
                    json.response.body.items.item.forEach(item => {
                        if(item.fcstDate === todayStr) { // ì˜¤ëŠ˜ ë‚ ì§œë§Œ
                            const h = parseInt(item.fcstTime.slice(0,2));
                            if(h >= 9 && h <= 22) { // 09ì‹œ ~ 22ì‹œ í•„í„°ë§
                                if(!hourly[h]) hourly[h] = {};
                                hourly[h][item.category] = item.fcstValue;
                            }
                        }
                    });

                    // 9ì‹œë¶€í„° 22ì‹œê¹Œì§€ ìˆœíšŒ
                    for(let i=9; i<=22; i++){
                        const d = hourly[i];
                        if (d) {
                            let icon = 'â˜€ï¸';
                            const pty = parseInt(d.PTY||0), sky = parseInt(d.SKY||1);
                            if(pty>0) icon = (pty===3)?'â„ï¸':'ğŸŒ§ï¸'; else if(sky===3) icon='ğŸŒ¤ï¸'; else if(sky===4) icon='â˜ï¸';
                            if(i>=19 && (icon==='â˜€ï¸'||icon==='ğŸŒ¤ï¸')) icon='ğŸŒ™';

                            gridHtml += `<div class="w-col"><div class="f-time">${i}h</div><div class="f-icon">${icon}</div><div class="f-temp">${d.TMP||'-'}Â°</div><div class="f-rain">${d.POP||0}%</div></div>`;
                        }
                    }
                }
            } catch(e) { gridHtml = `<div style="padding:10px; font-size:12px; color:red;">Loading Failed (Check CORS Button)</div>`; }

            listDiv.innerHTML += `<div class="loc-card"><div class="loc-header"><span class="loc-name">${loc.main}</span><span class="loc-sub">${loc.sub}</span></div><div class="w-grid">${gridHtml || 'No Data'}</div></div>`;
        }
    }

    // === 4. ì£¼ê°„ ë‚ ì”¨ (ë³µêµ¬ë¨) ===
    async function initWeeklyWeather() {
        const statusSpan = document.getElementById('update-info-weekly');
        const listDiv = document.getElementById('list-weekly');
        statusSpan.innerText = "Loading...";

        const locations = [
            { name: "æµå·å¸‚", sub: "Jeju", regIdTemp: '11G00201', regIdLand: '11G00000', nx: 52, ny: 38 },
            { name: "è¥¿å½’æµ¦", sub: "Seogwipo", regIdTemp: '11G00401', regIdLand: '11G00000', nx: 52, ny: 32 },
            { name: "æ±‰æ‹¿å±±", sub: "Mt.Halla", regIdTemp: '11G00401', regIdLand: '11G00000', nx: 52, ny: 35 },
            { name: "ç‰›å²›", sub: "Udo", regIdTemp: '11G00302', regIdLand: '11G00000', nx: 60, ny: 38 }
        ];

        // ì¤‘ê¸°ì˜ˆë³´ ê¸°ì¤€ ì‹œê°„ ê³„ì‚° (06ì‹œ, 18ì‹œ)
        const h = now.getHours();
        let midTmFc = `${todayStr}0600`;
        if (h >= 18) midTmFc = `${todayStr}1800`;
        else if (h < 6) {
            const yD = new Date(now); yD.setDate(now.getDate() - 1);
            midTmFc = `${getFormatDate(yD)}1800`;
        }

        // ë‹¨ê¸°ì˜ˆë³´ ê¸°ì¤€ (ì˜¤ëŠ˜~ëª¨ë ˆ ë°ì´í„°ìš©)
        let shortBaseDate = todayStr;
        let shortBaseTime = "0200";
        if (now.getHours() < 2) {
            const yD = new Date(now); yD.setDate(now.getDate() - 1);
            shortBaseDate = getFormatDate(yD);
            shortBaseTime = "2300";
        }

        let isFirst = true;

        for (const loc of locations) {
            let combinedData = {};

            // A. ë‹¨ê¸°ì˜ˆë³´ (0~2ì¼)
            try {
                const urlS = `${PROXY}https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst?serviceKey=${API_KEY}&numOfRows=1000&pageNo=1&dataType=JSON&base_date=${shortBaseDate}&base_time=${shortBaseTime}&nx=${loc.nx}&ny=${loc.ny}`;
                const resS = await fetch(urlS);
                const jsonS = await resS.json();

                if(jsonS.response.header.resultCode === '00'){
                    const tempDays = {};
                    jsonS.response.body.items.item.forEach(it => {
                        const date = it.fcstDate;
                        if(!tempDays[date]) tempDays[date] = { min:100, max:-100, sky:1, pty:0, temps:[], pop:0 };
                        if(it.category==='TMN') tempDays[date].min = parseFloat(it.fcstValue);
                        if(it.category==='TMX') tempDays[date].max = parseFloat(it.fcstValue);
                        if(it.category==='TMP') tempDays[date].temps.push(parseFloat(it.fcstValue));
                        if(it.category==='POP') tempDays[date].pop = Math.max(tempDays[date].pop, parseInt(it.fcstValue));
                        if(it.category==='PTY') tempDays[date].pty = Math.max(tempDays[date].pty, parseInt(it.fcstValue));
                        if(it.category==='SKY') tempDays[date].sky = parseInt(it.fcstValue);
                    });

                    for(let i=0; i<=2; i++){
                        const d = new Date(now); d.setDate(now.getDate() + i);
                        const dStr = getFormatDate(d);
                        const t = tempDays[dStr];
                        if(t) {
                            if(t.min===100 && t.temps.length>0) t.min = Math.min(...t.temps);
                            if(t.max===-100 && t.temps.length>0) t.max = Math.max(...t.temps);
                            let wf = "ë§‘ìŒ";
                            if(t.pty>0) wf = (t.pty===3)?"ëˆˆ":"ë¹„"; else if(t.sky>5) wf="íë¦¼"; else if(t.sky>8) wf="êµ¬ë¦„ë§ìŒ";
                            combinedData[i] = { min: t.min, max: t.max, wf: wf, pop: t.pop };
                        }
                    }
                }
            } catch(e) {}

            // B. ì¤‘ê¸°ì˜ˆë³´ (3~10ì¼)
            try {
                const urlT = `${PROXY}https://apis.data.go.kr/1360000/MidFcstInfoService/getMidTa?serviceKey=${API_KEY}&numOfRows=1&pageNo=1&dataType=JSON&regId=${loc.regIdTemp}&tmFc=${midTmFc}`;
                const resT = await fetch(urlT);
                const jsonT = await resT.json();

                const urlL = `${PROXY}https://apis.data.go.kr/1360000/MidFcstInfoService/getMidLandFcst?serviceKey=${API_KEY}&numOfRows=1&pageNo=1&dataType=JSON&regId=${loc.regIdLand}&tmFc=${midTmFc}`;
                const resL = await fetch(urlL);
                const jsonL = await resL.json();

                if(jsonT.response.header.resultCode === '00' && jsonL.response.header.resultCode === '00') {
                    const tItem = jsonT.response.body.items.item[0];
                    const lItem = jsonL.response.body.items.item[0];
                    for(let i=3; i<=10; i++) {
                        combinedData[i] = {
                            min: tItem[`taMin${i}`], max: tItem[`taMax${i}`],
                            wf: lItem[`wf${i}Pm`] || lItem[`wf${i}`],
                            pop: lItem[`rnSt${i}Pm`] || lItem[`rnSt${i}`]
                        };
                    }
                }
            } catch(e) {}

            if(isFirst) { listDiv.innerHTML = ''; isFirst = false; }

            // C. ë Œë”ë§
            let gridHtml = '';
            for(let i=0; i<=10; i++) {
                const w = combinedData[i];
                if(w) {
                    const d = new Date(now); d.setDate(now.getDate() + i);
                    const label = (i===0) ? "Today" : `${d.getMonth()+1}/${d.getDate()}`;

                    let icon = 'â˜€ï¸';
                    if(w.wf && (w.wf.includes('íë¦¼')||w.wf.includes('êµ¬ë¦„'))) icon = 'â˜ï¸';
                    if(w.wf && (w.wf.includes('ë¹„')||w.wf.includes('ì†Œë‚˜ê¸°'))) icon = 'ğŸŒ§ï¸';
                    if(w.wf && w.wf.includes('ëˆˆ')) icon = 'â„ï¸';

                    gridHtml += `
                    <div class="w-col">
                        <div class="f-time">${label}</div>
                        <div class="f-icon">${icon}</div>
                        <div class="f-temp"><span class="t-high">${w.max||'-'}</span>/<span class="t-low">${w.min||'-'}</span></div>
                        <div class="f-rain pop-blue">${w.pop||0}%</div>
                    </div>`;
                }
            }
            listDiv.innerHTML += `<div class="loc-card"><div class="loc-header"><span class="loc-name">${loc.name}</span><span class="loc-sub" style="font-size:10px;">${loc.sub}</span></div><div class="w-grid">${gridHtml || 'No Data (Check CORS)'}</div></div>`;
        }
        statusSpan.innerText = "Updated";
    }

    initCCTV();
    initDailyWeather();
    setTimeout(initWeeklyWeather, 1000); // 1ì´ˆ ë’¤ ì£¼ê°„ì˜ˆë³´ ì‹¤í–‰
</script>
</body>
</html>
